<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goott.eco.mapper.GoodsMapper">
	
	<insert id="test" parameterType="map">
		INSERT INTO TB_TEST VALUES(#{no}, #{val})
	</insert>
	
	<select id="goodsListCount" resultType="int" parameterType="map">
		SELECT COUNT(*) FROM GOODS  
		WHERE
			1=1
			<if test="category != null and category != ''">
			AND CATEGORY = #{category}	
			</if>
			<if test="name != null and name != ''">
			AND GOODS_NAME LIKE '%#{name}%'
			</if>
	</select>
	
	<select id="getGoodsList" resultType="map" parameterType="map">
		SELECT 
			  G.GOODS_SEQ, G.GOODS_NAME, G.PRICE, G.ECO_SCORE
			, GTN.IMG_URL
			, (SELECT NVL( ROUND( AVG( NVL(STAR,0) ), 1 ), 0) FROM GOODS_STAR WHERE GOODS_STAR.GOODS_SEQ = G.GOODS_SEQ) AS STAR
		FROM GOODS G 
		LEFT OUTER JOIN GOODS_THUMB_NAIL GTN ON G.GOODS_SEQ = GTN.GOODS_SEQ AND GTN.MAIN_YN = 'Y'
		WHERE
			1=1
			<if test="category != null and category != ''">
			AND CATEGORY = #{category}	
			</if>
			<if test="name != null and name != ''">
			AND GOODS_NAME LIKE '%#{name}%'
			</if>
		OFFSET 0 ROWS FETCH FIRST 100 ROWS ONLY
	</select>
	
	<select id="insertGoods" statementType="CALLABLE" parameterType="com.goott.eco.domain.GoodsVO">
		{call PROC_GOODS_INS(
		     #{goods_seq,mode=OUT,jdbcType=INTEGER}
		    ,#{comp_seq,mode=IN,jdbcType=INTEGER}
		    ,#{goods_name,mode=IN,jdbcType=VARCHAR}
		    ,#{goods_detail,mode=IN,jdbcType=CLOB}
		    ,#{price,mode=IN,jdbcType=INTEGER}
		    ,#{qty,mode=IN,jdbcType=INTEGER}
		    ,#{material,mode=IN,jdbcType=VARCHAR}
		    ,#{category,mode=IN,jdbcType=INTEGER}
		    ,#{eco_score,mode=IN,jdbcType=INTEGER}
		    ,#{reguser,mode=IN,jdbcType=VARCHAR}
		    ,#{req_option,mode=IN,jdbcType=VARCHAR}
		    )
		}
	</select>
	
	<delete id="realDeleteGoods" parameterType="int">
		DELETE FROM GOODS WHERE GOODS_SEQ = #{goodsSeq}
	</delete>
	
	<insert id="insertGoodsThumbNail" parameterType="com.goott.eco.domain.GoodsVO">
		INSERT INTO GOODS_THUMB_NAIL(
			 GOODS_SEQ
			,GOODS_THUM_NAIL_SEQ
			,IMG_URL
			,MAIN_YN
			,REGDATE
			,REGUSER
			,EDITDATE
			,EDITUSER
		) VALUES (
			#{goods_seq}
			,(SELECT NVL(MAX(GOODS_THUM_NAIL_SEQ),0) + 1 FROM GOODS_THUMB_NAIL WHERE GOODS_SEQ = #{goods_seq})
			,#{img_url}
			,#{main_yn}
			,SYSDATE
			,#{reguser}
			,NULL
			,NULL )
	</insert>

</mapper>